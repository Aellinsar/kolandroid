package com.starfish.kol.connection;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Serializable;
import java.io.StringWriter;
import java.net.HttpURLConnection;

import com.starfish.kol.gamehandler.LoadingContext;

public class ServerReply implements Serializable {
	/**
	 * Autogenerated by eclipse.
	 */
	private static final long serialVersionUID = -7171484980493452228L;

	public final int responseCode;
	public final String redirectLocation;
	public final String date;
	public final String url;
	public final String cookie;

	public final String html;

	public ServerReply(int responseCode, String redirectLocation, String date,
			String html, String url, String cookie) {
		this.responseCode = responseCode;
		this.redirectLocation = redirectLocation;
		this.date = date;
		this.html = html;
		this.url = url;
		this.cookie = cookie;
	}

	protected ServerReply(PartialServerReply reply, String html)
			throws IOException {
		this.responseCode = reply.responseCode;
		this.redirectLocation = reply.redirectLocation;
		this.date = reply.date;
		this.url = reply.url;
		this.cookie = reply.cookie;

		this.html = html;
	}

	protected ServerReply(PartialServerReply reply, HttpURLConnection base,
			LoadingContext loading) throws IOException {
		this(reply, getResponse(base, loading));
	}

	private static String getResponse(HttpURLConnection base,
			LoadingContext loading) throws IOException {
		InputStream is = base.getInputStream();
		if (is == null)
			return "";

		String url = base.getURL().toString();

		loading.start(url);

		try {
			StringWriter sw = new StringWriter();

			BufferedReader r = new BufferedReader(new InputStreamReader(is));
			String s;

			while ((s = r.readLine()) != null) {
				sw.append(s + '\n');
			}

			loading.complete(url);
			r.close();
			return sw.toString();
		} catch (IOException e) {
			loading.error(url);
			throw e;
		}
	}

	@Override
	public String toString() {
		String s = "RESPONSE CODE: " + responseCode;
		if (responseCode / 100 == 3)
			s += "\nREDIRECT: " + redirectLocation;
		s += "\nRESULT: " + html;
		return s;
	}
}
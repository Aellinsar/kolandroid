package com.starfish.kol.model.models;

import java.math.BigInteger;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

import com.starfish.kol.connection.Connection.ServerReply;
import com.starfish.kol.connection.Session;
import com.starfish.kol.gamehandler.GameHandler;
import com.starfish.kol.gamehandler.ViewContext;
import com.starfish.kol.model.Model;
import com.starfish.kol.model.models.LoginModel.LoginStatus;
import com.starfish.kol.request.Request;
import com.starfish.kol.request.ResponseHandler;
import com.starfish.kol.request.SingleRequest;
import com.starfish.kol.util.Regex;

public class LoginModel extends Model<LoginStatus> {
	/**
	 * Autogenerated by eclipse.
	 */
	private static final long serialVersionUID = -8728194484440083488L;

	private static final Regex SERVER = new Regex("^appserver=(.*)$", 1);

	private static final Regex LOGIN_ID = new Regex(
			".*/login.php\\?loginid=(.*)", 1);
	private static final Regex CHALLENGE = new Regex(
			"<input type=hidden name=challenge value=\"([^\"]*?)\">", 1);

	public LoginModel() {
		super(new Session());
	}
	
	public void cheat(ViewContext context) {
		Request req = new Request("static.php?id=whatiskol",
				new GameHandler(context));
		this.makeRequest(req);
	}

	public void login(final ViewContext context, final String username, final String pass) {
		this.notifyView(LoginStatus.STARTING);

		Request req = new Request("login.php", new ResponseHandler() {
			@Override
			public boolean handle(Session session, Request request,
					ServerReply response) {
				String loginId = LOGIN_ID.extractSingle(response.url);
				String challenge = CHALLENGE.extractSingle(response.html);
				String server = SERVER.extractSingle(response.cookie);

				if (loginId == null || challenge == null || server == null) {
					notifyView(LoginStatus.FAILED_ACCESS);
					return true;
				}

				session.setCookie(response.cookie);
				String[] names = { "loginid", "loginname", "password",
						"loggingin", "challenge", "response", "secure" };
				String[] vals = { loginId, username, "", "Yup.", challenge,
						digestPassword(pass, challenge), "1" };
				notifyView(LoginStatus.HALFWAY);

				Request login = new SingleRequest("login.php", names, vals,
						new ResponseHandler() {

							@Override
							public boolean handle(Session session,
									Request request, ServerReply response) {
								System.out.println("Logincookie: "
										+ response.cookie);
								if (!response.cookie.contains("PHPSESSID=")) {
									// Failure to login
									notifyView(LoginStatus.FAILED_LOGIN);
									return true;
								}

								notifyView(LoginStatus.SUCCESS);

								session.setCookie(response.cookie);
								Request game = new Request("main.php", new GameHandler(context));
								// Request game = new
								// Request("craft.php?mode=combine",
								// ResponseHandler.none);
								game.makeAsync(session);
								return true;
							}

						});

				login.makeAsync(session);
				return true;
			}
		});
		this.makeRequest(req);
	}

	// Password encoding blatantly stolen from KoLMafia
	private static String digestPassword(String password, String challenge) {
		// KoL now makes use of a HMAC-MD5 in order to preprocess the
		// password so that we aren't submitting plaintext passwords
		// all the time. Here is the implementation. Note that the
		// password is processed two times.

		try {
			MessageDigest digester = MessageDigest.getInstance("MD5");
			String hash1 = getHexString(digester.digest(password.getBytes()));
			digester.reset();

			String hash2 = getHexString(digester
					.digest((hash1 + ":" + challenge).getBytes()));
			digester.reset();

			return hash2;
		} catch (NoSuchAlgorithmException e) {
			e.printStackTrace();
		}

		return "";
	}

	private static final String getHexString(final byte[] bytes) {
		byte[] output = new byte[bytes.length + 1];
		for (int i = 0; i < bytes.length; ++i) {
			output[i + 1] = bytes[i];
		}

		StringBuffer result = new StringBuffer(
				(new BigInteger(output)).toString(16));
		int desiredLength = bytes.length * 2;

		while (result.length() < desiredLength) {
			result.insert(0, '0');
		}

		if (result.length() > desiredLength) {
			result.delete(0, result.length() - desiredLength);
		}

		return result.toString();
	}

	public enum LoginStatus {
		STARTING, HALFWAY, SUCCESS, FAILED_ACCESS, FAILED_LOGIN;
	}
}

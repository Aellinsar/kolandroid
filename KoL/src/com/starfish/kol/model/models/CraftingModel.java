package com.starfish.kol.model.models;

import java.util.ArrayList;

import com.starfish.kol.connection.Connection.ServerReply;
import com.starfish.kol.model.Model;
import com.starfish.kol.model.util.LiveModel;
import com.starfish.kol.util.Regex;

public class CraftingModel extends Model<Void> {
	/**
	 * Autogenerated by eclipse.
	 */
	private static final long serialVersionUID = -4634759533016983940L;

	private CraftingSubModel[] crafts;
	
	private static final Regex RESULTS_PANE = new Regex(
			"<table[^>]*><tr><td[^>]*><b>Results:.*?</table>", 0);
	private static final Regex PAGE_BODY = new Regex(
			"(<body[^>]*>)(.*?)(</body>)", 2);
	private String resultsPane;
	
	private static final Regex TOP_BAR = new Regex("(<body>.*?)<table.*?</table>.*?</table>", 0);
	
	private static final Regex SELECTION = new Regex("\\[[^\\]]*\\]", 0);
	private static final Regex CRAFT_TITLE = new Regex("\\[(?:<[^>]*>)?([^<]*)(?:<[^>]*>)?\\]", 1);
	private static final Regex CRAFT_LINK = new Regex("\\[<a href=[\"']?([^>]*?)[\"']?>*>[^<]*<[^>]*>\\]", 1);
	
	private int initialSlot;
	
	public CraftingModel(ServerReply reply) {
		super(reply);
		
		ArrayList<String> options = SELECTION.extractAllSingle(TOP_BAR.extractSingle(reply.html));
		
		initialSlot = 0;
		crafts = new CraftingSubModel[options.size()];
		for(int i = 0; i < options.size(); i++) {
			String title = CRAFT_TITLE.extractSingle(options.get(i));
			String link = CRAFT_LINK.extractSingle(options.get(i));
			if(link == null) {
				initialSlot = i;
				link = "";
			}
			System.out.println("Found: " + title + " @ " + link);
			
			crafts[i] = new CraftingSubModel(title, link);
		}
		
		if(crafts.length == 0) {
			crafts = new CraftingSubModel[]{new CraftingSubModel("Error", "crafting.php")};
		}
		System.out.println("Loaded " + crafts.length + " crafts; selected " + initialSlot);
		
		resultsPane = RESULTS_PANE.extractSingle(reply.html);
		crafts[initialSlot].process(reply);
	}

	public WebModel getResultsPane() {
		if (resultsPane == null)
			return null;

		ServerReply base = this.getBase();
		String html = PAGE_BODY.replaceAll(base.html, "$1<center>"
				+ resultsPane + "</center>$3");
		ServerReply newRep = new ServerReply(base.responseCode,
				base.redirectLocation, base.date, html, "small/craftingresults.php",
				base.cookie);
		return new WebModel(newRep);
	}
	
	public int getNumberSlots() {
		return crafts.length;
	}
	
	public CraftingSubModel getSlot(int slot) {
		return crafts[slot];
	}
	
	public int getInitialSlot() {
		return initialSlot;
	}
	
	public class CraftingSubModel extends LiveModel{
		/**
		 * Autogenerated by eclipse.
		 */
		private static final long serialVersionUID = -7806837522602916575L;
			
		private String title;
		private WebModel base;
		
		public CraftingSubModel(String title, String updateUrl) {
			super(updateUrl);
			this.base = new WebModel(new ServerReply(200, "", "", "", "", ""));
			this.title = title;
		}

		@Override
		protected void loadContent(ServerReply content) {
			ServerReply newRep = new ServerReply(content.responseCode,
					content.redirectLocation, content.date, TOP_BAR.replaceAll(content.html, "$1"), content.url,
					content.cookie);
			this.base = new WebModel(newRep);
		}
		
		public String getTitle() {
			return title;
		}
		
		public WebModel getBaseModel() {
			this.access();
			return base;
		}

	}
}

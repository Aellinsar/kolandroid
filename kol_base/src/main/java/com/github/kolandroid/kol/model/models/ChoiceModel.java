package com.github.kolandroid.kol.model.models;

import com.github.kolandroid.kol.connection.ServerReply;
import com.github.kolandroid.kol.connection.Session;
import com.github.kolandroid.kol.model.elements.ActionElement;
import com.github.kolandroid.kol.util.Regex;

import java.util.ArrayList;

/**
 * A model for choice.php
 */
public class ChoiceModel extends WebModel {
    /**
     * Autogenerated by eclipse.
     */
    private static final long serialVersionUID = -9107242519455349408L;

    private static final Regex OPTIONS = new Regex("<form[^>]*>(.*?)</form>", 1);

    private static final Regex PWD_INPUT = new Regex("(<input[^>]*name=[\"']?pwd[^>]*>)", 1);
    private static final Regex WHICH_INPUT = new Regex("(<input[^>]*name=[\"']?whichchoice[^>]*>)", 1);
    private static final Regex OPTION_INPUT = new Regex("(<input[^>]*name=[\"']?option[^>]*>)", 1);
    private static final Regex SUBMIT_INPUT = new Regex("(<input[^>]*type=[\"']?submit[^>]*>)", 1);

    private static final Regex ALPHA_NUM_VALUE = new Regex("value=[\"']?([a-f0-9]+)[\"'>]", 1);
    private static final Regex NUM_VALUE = new Regex("value=[\"']?(\\d+)[\"'>]", 1);
    private static final Regex VALUE = new Regex("value=[\"]?(.*?)[\">]", 1);

    //The list of possible options extracted from the choice.
    private ArrayList<ActionElement> options;

    public ChoiceModel(Session s, ServerReply response) {
        super(s, new ServerReply(response, filterHtml(response.html)));

        this.extractOptions(response.html);
    }

    private static String filterHtml(String html) {
        return OPTIONS.replaceAll(html, "");
    }

    /**
     * Extract the choice id of a choice.php page.
     *
     * @param server The page to parse.
     * @return The choice id of the page, or -1 if not found.
     */
    public static int extractChoiceId(ServerReply server) {
        String whichchoice = NUM_VALUE.extractSingle(WHICH_INPUT.extractSingle(server.html), "-1");
        try {
            return Integer.parseInt(whichchoice);
        } catch (Exception e) {
            return -1;
        }
    }

    /**
     * Extract all the choices from the page.
     * @param html  The page to extract from
     */
    private void extractOptions(String html) {
        this.options = new ArrayList<>();
        for (String form : OPTIONS.extractAllSingle(html)) {
            System.out.println("Found option: " + form);

            String pwd = ALPHA_NUM_VALUE.extractSingle(PWD_INPUT.extractSingle(form));
            String whichchoice = NUM_VALUE.extractSingle(WHICH_INPUT.extractSingle(form));
            String option = NUM_VALUE.extractSingle(OPTION_INPUT.extractSingle(form));
            String text = VALUE.extractSingle(SUBMIT_INPUT.extractSingle(form));

            if (pwd == null || whichchoice == null || option == null) continue;

            text = text.replace("&quot;", "\"");

            String action = "choice.php?pwd=" + pwd + "&whichchoice=" + whichchoice + "&option=" + option;
            options.add(new ActionElement(getSession(), text, action));
        }
    }

    public ArrayList<ActionElement> getOptions() {
        return this.options;
    }
}

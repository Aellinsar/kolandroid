package com.github.kolandroid.kol.android.controllers.web;

import android.annotation.SuppressLint;
import android.content.Intent;
import android.net.Uri;
import android.util.Log;
import android.view.View;
import android.webkit.WebResourceResponse;
import android.webkit.WebView;
import android.webkit.WebViewClient;

import com.github.kolandroid.kol.android.R;
import com.github.kolandroid.kol.android.controller.UpdatableModelController;
import com.github.kolandroid.kol.android.game.GameScreen;
import com.github.kolandroid.kol.android.screen.DialogScreen;
import com.github.kolandroid.kol.android.screen.Screen;
import com.github.kolandroid.kol.android.screen.ScreenSelection;
import com.github.kolandroid.kol.model.models.WebModel;
import com.github.kolandroid.kol.util.Callback;
import com.github.kolandroid.kol.util.Logger;
import com.github.kolandroid.kol.util.Regex;

import java.io.InputStream;
import java.lang.ref.WeakReference;

public class WebController extends UpdatableModelController<WebModel> {
    /**
     * Autogenerated by eclipse.
     */
    private static final long serialVersionUID = -8051419766943400254L;

    private final static Regex BODY_TAG = new Regex("<body[^>]*?>");

    private transient WebView web;

    public WebController(WebModel model) {
        super(model);
    }

    public void updateModel(WebModel base) {
        super.updateModel(base);
        if (web != null) {
            String fixedHtml = BODY_TAG
                    .replaceAll(base.getHTML(),
                            "$0<meta name=\"viewport\" content=\"width=device-width\">");
            web.loadDataWithBaseURL(base.getURL(), fixedHtml, "text/html", null,
                    null);
            web.invalidate();
        }
    }

    @Override
    public int getView() {
        return getModel().visitType(new WebModel.WebModelTypeVisitor<Integer>() {
            public Integer forRegular() {
                return R.layout.fragment_web_screen;
            }

            public Integer forSmall() {
                return R.layout.dialog_web_screen;
            }

            public Integer forResults() {
                return R.layout.dialog_results_screen;
            }
        });
    }

    @Override
    public void chooseScreen(final ScreenSelection choice) {
        getModel().visitType(new WebModel.WebModelTypeVisitor<Void>() {
            public Void forRegular() {
                choice.displayPrimary(WebController.this);
                return null;
            }

            public Void forSmall() {
                choice.displayDialog(WebController.this);
                return null;
            }

            public Void forResults() {
                choice.displayDialog(WebController.this);
                return null;
            }
        });
    }

    @SuppressLint({"SetJavaScriptEnabled", "AddJavascriptInterface"})
    @Override
    public void connect(View view, WebModel model, final Screen host) {
        WebViewClient client = new WebViewClient() {
            @Override
            public boolean shouldOverrideUrlLoading(WebView view, String url) {
                Logger.log("Request", "Request made to " + url);

                if (url.startsWith("data:text/html"))
                    return true;

                url = url.replace("reallyquitefake/", "");
                Log.i("WebFragment", "Request made to " + url);
                if (!getModel().makeRequest(url)) {
                    Log.i("WebFragment", "External request: " + url);

                    // Otherwise, the link is not for a kol page; launch an
                    // external activity
                    Intent intent = new Intent(Intent.ACTION_VIEW,
                            Uri.parse(url));
                    host.getActivity().startActivity(intent);
                }

                return true;
            }

            @Override
            public WebResourceResponse shouldInterceptRequest(WebView view, String url) {
                if (url.startsWith("data:text/html"))
                    return null;

                if (url.contains(".php")) {
                    //All requests to .php must include the proper cookies
                    InputStream result = getModel().makeBlockingRequest(url);
                    return new WebResourceResponse("text/html; charset=UTF-8", null, result);
                } else {
                    return null;
                }
            }
        };

        web = (WebView) view.findViewById(R.id.webview);
        // Fix the viewport size by inserting a viewport tag
        String fixedHtml = BODY_TAG
                .replaceAll(model.getHTML(),
                        "$0<meta name=\"viewport\" content=\"width=device-width\">");
        Log.i("WebFragment", "Loading content of size " + fixedHtml.length());

        web.getSettings().setBuiltInZoomControls(true);
        web.getSettings().setLoadWithOverviewMode(true);
        web.getSettings().setUseWideViewPort(true);
        web.getSettings().setJavaScriptEnabled(true);
        web.addJavascriptInterface(new JavaScriptInterface(host), "ANDROIDAPP");

		/*
        CookieSyncManager syncManager = CookieSyncManager.createInstance(web.getContext());
		CookieManager cookieManager = CookieManager.getInstance();
		cookieManager.setAcceptCookie(true);
		cookieManager.removeAllCookie();

		SystemClock.sleep(1000);
		Session session = model.getSession();
		cookieManager.setCookie("www.kingdomofloathing.com", session.getCookie());
		//cookieManager.setCookie("www.kingdomofloathing.com", "appserver=" + session.getServer());
		Logger.log("CookieSetting", session.getCookie());
		//Logger.log("CookieSetting", "appserver=" + session.getServer());
		syncManager.sync();
		*/

        web.setWebViewClient(client);
        web.loadDataWithBaseURL(model.getURL(), fixedHtml, "text/html", null,
                null);

        web.invalidate();


    }

    class JavaScriptInterface {
        private final WeakReference<Screen> host;

        public JavaScriptInterface(Screen host) {
            this.host = new WeakReference<>(host);
        }

        @android.webkit.JavascriptInterface
        public void debug(String text) {
            Log.i("WebFragment Form", "Debug: " + text);
        }

        @android.webkit.JavascriptInterface
        public void processFormData(String formData) {
            Logger.log("WebController", "Form data: " + formData);
            getModel().makeRequest(formData);
        }

        @android.webkit.JavascriptInterface
        public void refreshStatsPane() {
            Screen host = this.host.get();
            if (host == null) return;

            if (host instanceof GameScreen) {
                ((GameScreen) host).refreshStatsPane();
            } else {
                Logger.log("WebController", "Pane refresh triggered by javascript, but host was " + host);
            }
        }

        @android.webkit.JavascriptInterface
        public void displayFormNumeric(String question, String button, final String onResult) {
            Logger.log("WebController", "Querying numeric value: " + question);

            TextInputController input = new TextInputController(button, new Callback<String>() {
                @Override
                public void execute(String result) {
                    result = result.replace("\"", ""); //attempt to stop OTHER javascript injection
                    result = onResult.replace("#VAL", "\"" + result + "\"");
                    Logger.log("WebController", "Result: [" + result + "]");
                    web.loadUrl(result);
                }
            });
            Screen host = this.host.get();
            if (host == null) return;
            DialogScreen.display(input, host, question);
        }
    }

}

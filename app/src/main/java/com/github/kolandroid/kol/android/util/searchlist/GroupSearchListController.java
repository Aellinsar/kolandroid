package com.github.kolandroid.kol.android.util.searchlist;

import android.text.Editable;
import android.text.TextWatcher;
import android.view.View;
import android.widget.EditText;
import android.widget.ExpandableListView;
import android.widget.ExpandableListView.OnChildClickListener;

import com.github.kolandroid.kol.android.R;
import com.github.kolandroid.kol.android.binders.Binder;
import com.github.kolandroid.kol.android.controller.Controller;
import com.github.kolandroid.kol.android.screen.Screen;
import com.github.kolandroid.kol.android.screen.ScreenSelection;
import com.github.kolandroid.kol.gamehandler.SettingsContext;
import com.github.kolandroid.kol.model.elements.ActionElement;
import com.github.kolandroid.kol.model.elements.interfaces.ModelGroup;
import com.github.kolandroid.kol.util.Logger;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.Set;

public class GroupSearchListController<F> implements Controller {
    /**
     * Autogenerated by eclipse.
     */
    private static final long serialVersionUID = -3034860712134386719L;

    private final String closedGroupsSetting;

    private final ListSelector<? super F> selector;
    private final Binder<? super ModelGroup<F>> groupBinder;
    private final Binder<? super F> childBinder;

    private ArrayList<ModelGroup<F>> base;

    private transient SettingsContext settings;
    private transient HighlightableListGroupAdapter<F> adapter;
    private transient ExpandableListView list;
    private boolean restoring;

    public GroupSearchListController(ArrayList<ModelGroup<F>> items, Binder<? super ModelGroup<F>> groupBinder, Binder<? super F> childBinder, ListSelector<? super F> selector) {
        this(items, "", groupBinder, childBinder, selector);
    }

    public GroupSearchListController(ArrayList<ModelGroup<F>> items, String closedGroupsSetting, Binder<? super ModelGroup<F>> groupBinder, Binder<? super F> childBinder, ListSelector<? super F> selector) {
        this.base = items;
        this.groupBinder = groupBinder;
        this.childBinder = childBinder;
        this.selector = selector;
        this.closedGroupsSetting = closedGroupsSetting;
    }

    public static <F extends ActionElement> GroupSearchListController<F> create(ArrayList<ModelGroup<F>> items, Binder<? super ModelGroup<F>> groupBinder, Binder<? super F> childBinder) {
        return new GroupSearchListController<>(items, groupBinder, childBinder, new ActionSelector<F>());
    }

    @Override
    public int getView() {
        return R.layout.group_search_list_view;
    }

    private void loadClosedGroups() {
        if (settings == null || list == null) return;

        restoring = true;
        Set<String> closedGroups;
        if (closedGroupsSetting.isEmpty()) {
            closedGroups = new HashSet<>();
        } else {
            closedGroups = settings.get(closedGroupsSetting, new HashSet<String>());
        }

        // Join the string values for the sake of logging
        StringBuilder logentry = new StringBuilder("[").append(closedGroupsSetting).append("] retrieved $strings[");
        for (String s : closedGroups) {
            logentry.append(s).append(", ");
        }
        logentry.append("]");
        Logger.log("GroupSearchListController", logentry.toString());

        for (int i = 0; i < adapter.getGroupCount(); i++) {
            if (closedGroups.contains(adapter.getName(i))) {
                list.collapseGroup(i);
            } else {
                list.expandGroup(i);
            }
        }
        restoring = false;
    }

    private void saveClosedGroups() {
        if (settings == null || list == null) return;
        if (closedGroupsSetting.isEmpty()) return;
        if (restoring)
            return;  //do not bother to save the group state while we are in the middle of loading it

        Set<String> closedGroups = settings.get(closedGroupsSetting, new HashSet<String>());
        for (int i = 0; i < adapter.getGroupCount() && i < base.size(); i++) {
            if (!list.isGroupExpanded(i)) {
                closedGroups.add(adapter.getName(i));
            } else {
                closedGroups.remove(adapter.getName(i));
            }
        }
        settings.set(closedGroupsSetting, closedGroups);
    }

    @Override
    public void attach(View view, final Screen host) {
        adapter = new HighlightableListGroupAdapter<>(view.getContext(), base, groupBinder, childBinder);
        list = (ExpandableListView) view.findViewById(R.id.search_list_base);
        list.setOnChildClickListener(new OnChildClickListener() {
            @Override
            public boolean onChildClick(ExpandableListView arg0, View arg1,
                                        int groupPosition, int childPosition, long id) {
                @SuppressWarnings("unchecked")
                F choice = (F) adapter.getChild(groupPosition, childPosition);
                if (selector != null)
                    if (selector.selectItem(host, choice)) {
                        host.close();
                    }
                return true;
            }

        });
        list.setAdapter(adapter);

        settings = host.getViewContext().getSettingsContext();

        loadClosedGroups();

        list.setOnGroupCollapseListener(new ExpandableListView.OnGroupCollapseListener() {
            @Override
            public void onGroupCollapse(int groupPosition) {
                saveClosedGroups();
            }
        });
        list.setOnGroupExpandListener(new ExpandableListView.OnGroupExpandListener() {
            @Override
            public void onGroupExpand(int groupPosition) {
                saveClosedGroups();
            }
        });

        final EditText text = (EditText) view
                .findViewById(R.id.search_list_input);
        text.addTextChangedListener(new TextWatcher() {
            @Override
            public void afterTextChanged(Editable s) {
                adapter.changeFilter(s.toString());
                loadClosedGroups();
            }

            @Override
            public void beforeTextChanged(CharSequence arg0, int arg1,
                                          int arg2, int arg3) {
                // ignored
            }

            @Override
            public void onTextChanged(CharSequence arg0, int arg1, int arg2,
                                      int arg3) {
                // ignored
            }
        });
    }

    @Override
    public void connect(View view, Screen host) {
        // Do nothing
    }

    public void setItems(ArrayList<ModelGroup<F>> base) {
        this.base = base;
        if (adapter != null && list != null) {
            adapter.setElements(base);
            loadClosedGroups();
        }
    }

    @Override
    public void disconnect(Screen host) {
        // Do nothing
    }

    @Override
    public void chooseScreen(ScreenSelection choice) {
        choice.displayPrimary(this);
    }

}
